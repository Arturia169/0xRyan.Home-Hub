services:
  # 情报大脑 - Bot + API + 监控服务
  backend:
    image: ghcr.io/arturia169/cyber-core-v2:latest
    container_name: cyber-backend
    privileged: true
    user: root
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./data/backend:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - HTTPS_PROXY=http://127.0.0.1:7890
      - HTTP_PROXY=http://127.0.0.1:7890
    restart: unless-stopped

  # Cloudflare Tunnel - 提供外部 HTTPS 访问（可选）
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cyber-tunnel
    restart: unless-stopped
    network_mode: host
    dns:
      - 8.8.8.8
      - 1.1.1.1
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
      - TUNNEL_HTTP_PROXY=http://127.0.0.1:7890
      - HTTPS_PROXY=http://127.0.0.1:7890
      - TUNNEL_TRANSPORT_PROTOCOL=http2
    command: tunnel --no-autoupdate run --protocol http2

  # 自动更新服务 - 每天检查一次镜像更新
  watchtower:
    image: containrrr/watchtower
    container_name: cyber-watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true # 自动清理旧镜像
      - WATCHTOWER_POLL_INTERVAL=3600 # 每1小时检查一次 (单位:秒)
      - WATCHTOWER_INCLUDE_STOPPED=true
    restart: unless-stopped
