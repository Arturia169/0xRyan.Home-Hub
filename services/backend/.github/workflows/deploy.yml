name: Deploy to Server

on:
  workflow_run:
    workflows: ["Build and Push to GHCR"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Deploy Application
        run: |
          cd /root/hbjk
          
          echo "ğŸ”„ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker-compose pull
          
          echo "ğŸš€ é‡å¯æœåŠ¡..."
          docker-compose down
          docker-compose up -d
          
          echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
          docker image prune -f
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          # æµ‹è¯•æœ¬åœ° API
          echo "ğŸ” æµ‹è¯•æœ¬åœ° API..."
          curl -s http://localhost:3000/health || echo "âŒ æœ¬åœ° API æ— å“åº”"
          
          # æµ‹è¯•å¤–éƒ¨è®¿é—®
          echo "ğŸŒ æµ‹è¯•å¤–éƒ¨è®¿é—®:"
          curl -s https://app.yukinetwork.eu.org/health || echo "âŒ å¤–éƒ¨è®¿é—®å¤±è´¥"
          
          # æ‰“å°æ—¥å¿—
          echo ""
          echo "ğŸ“ Bot å®¹å™¨æ—¥å¿—:"
          docker logs crypto-wallet-monitor --tail 30
          
          echo ""
          echo "ğŸ“ Cloudflare Tunnel æ—¥å¿—:"
          docker logs cloudflare-tunnel --tail 50
          
          echo ""
          echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
          docker-compose ps